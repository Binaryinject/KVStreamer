# KVStreamer

ä¸­æ–‡ | [English](./README.md)

ä¸€ä¸ªç”¨äºUnityçš„é«˜æ€§èƒ½é”®å€¼å¯¹æµå¼è¯»å–C#åº“,æ”¯æŒä»CSVæ–‡ä»¶ç”Ÿæˆç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼,å¹¶æä¾›å¸¦æ—¶é—´æ§åˆ¶çš„æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿã€‚

## âœ¨ ç‰¹æ€§

- ğŸ“ **CSVåˆ°äºŒè¿›åˆ¶è½¬æ¢**: ä»CSVæ–‡ä»¶ï¼ˆIDåˆ—ä¸ºkeyï¼ŒTextåˆ—ä¸ºvalueï¼‰ç”Ÿæˆä¼˜åŒ–çš„äºŒè¿›åˆ¶æ–‡ä»¶
- ğŸ—œï¸ **GZipå‹ç¼©**: å†…ç½®GZipå‹ç¼©æ”¯æŒï¼Œæ–‡ä»¶å¤§å°å‡å°‘60-70%ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
- ğŸ—ºï¸ **Mapå¤´ç´¢å¼•**: äºŒè¿›åˆ¶æ–‡ä»¶åŒ…å«Mapå¤´ï¼Œå®ç°å¿«é€Ÿçš„é”®å€¼æŸ¥æ‰¾
- ğŸš€ **æµå¼è¯»å–**: ä½¿ç”¨MemoryStreamè¯»å–ï¼Œæ”¯æŒbyte[]è¾“å…¥ï¼Œé€‚åˆUnityèµ„æºç³»ç»Ÿ
- ğŸ’¾ **æ™ºèƒ½ç¼“å­˜**: å¸¦è¿‡æœŸæ—¶é—´çš„ç¼“å­˜ç³»ç»Ÿï¼Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
- ğŸ¯ **å†…å­˜ä¼˜åŒ–**: æŒ‰éœ€è¯»å–valueï¼Œæœ€å°åŒ–å†…å­˜å ç”¨
- ğŸ”’ **çº¿ç¨‹å®‰å…¨**: æ–‡ä»¶è¯»å–æ“ä½œä½¿ç”¨lockä¿æŠ¤
- âš¡ **æ€§èƒ½å‡ºè‰²**: GCå‹åŠ›ä½ï¼Œé€‚åˆç§»åŠ¨å¹³å°å’Œå¤§æ•°æ®é‡åœºæ™¯
- ğŸ”„ **å‘åå…¼å®¹**: è‡ªåŠ¨æ£€æµ‹å¹¶åŠ è½½å‹ç¼©å’Œæœªå‹ç¼©æ ¼å¼

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
KVStreamer/
â”œâ”€â”€ KVStreamer.cs          # ä¸»ç±»ï¼Œæä¾›æ‰€æœ‰æ ¸å¿ƒAPI
â”œâ”€â”€ ValueCache.cs          # å€¼ç¼“å­˜ç³»ç»Ÿ
â”œâ”€â”€ Example/
â”‚   â”œâ”€â”€ example_data.csv   # ç¤ºä¾‹CSVæ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ Program.cs         # ä½¿ç”¨ç¤ºä¾‹ä»£ç 
â””â”€â”€ README.md
```

## ğŸ”§ äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼

ç”Ÿæˆçš„.bytesæ–‡ä»¶æ ¼å¼å¦‚ä¸‹ï¼š

```
[å‹ç¼©æ ‡å¿—(1å­—èŠ‚)]  # 0xC0 = å·²å‹ç¼©, 0x00 = æœªå‹ç¼©
[å‹ç¼©/æœªå‹ç¼©æ•°æ®]
    â”œâ”€â”€ [Mapå¤´å¤§å°(4å­—èŠ‚)]
    â”œâ”€â”€ [Mapå¤´æ•°æ®]
    â”‚   â”œâ”€â”€ [Key1é•¿åº¦(4å­—èŠ‚)][Key1å­—ç¬¦ä¸²][Value1åç§»é‡(8å­—èŠ‚)]
    â”‚   â”œâ”€â”€ [Key2é•¿åº¦(4å­—èŠ‚)][Key2å­—ç¬¦ä¸²][Value2åç§»é‡(8å­—èŠ‚)]
    â”‚   â””â”€â”€ ...
    â””â”€â”€ [Valueæ•°æ®]
        â”œâ”€â”€ [Value1é•¿åº¦(4å­—èŠ‚)][Value1å­—ç¬¦ä¸²]
        â”œâ”€â”€ [Value2é•¿åº¦(4å­—èŠ‚)][Value2å­—ç¬¦ä¸²]
        â””â”€â”€ ...
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡CSVæ–‡ä»¶

åˆ›å»ºä¸€ä¸ªCSVæ–‡ä»¶ï¼Œå¿…é¡»åŒ…å«`ID`å’Œ`Text`ä¸¤åˆ—ï¼š

```csv
ID,Text,Description
item_001,è¿™æ˜¯ç¬¬ä¸€ä¸ªç‰©å“,ç‰©å“æè¿°1
item_002,è¿™æ˜¯ç¬¬äºŒä¸ªç‰©å“,ç‰©å“æè¿°2
npc_001,æ‘é•¿å¯¹è¯æ–‡æœ¬,NPCå¯¹è¯
```

### 2. ä»CSVç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶

```csharp
using KVStreamer;

// åˆ›å»ºKVStreamerå®ä¾‹
using (KVStreamer streamer = new KVStreamer())
{
    // ç”Ÿæˆå‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆé»˜è®¤ï¼‰
    streamer.CreateBinaryFromCSV("data.csv", "data.bytes");
    
    // æˆ–è€…ç”Ÿæˆæœªå‹ç¼©çš„æ–‡ä»¶
    streamer.CreateBinaryFromCSV("data.csv", "data.bytes", compress: false);
}
```

### 3. åŠ è½½å¹¶è¯»å–æ•°æ®

```csharp
using (KVStreamer streamer = new KVStreamer(cacheDuration: 300f)) // 300ç§’ç¼“å­˜
{
    // æ–¹å¼1: ä»æ–‡ä»¶è·¯å¾„åŠ è½½
    streamer.LoadBinaryFile("data.bytes");
    
    // æ–¹å¼2: ä»byte[]åŠ è½½ï¼ˆUnityæ¨èï¼‰
    byte[] data = File.ReadAllBytes("data.bytes");
    streamer.LoadBinaryData(data);
    
    // é€šè¿‡Keyè·å–Value
    string text = streamer.GetValue("item_001");
    Console.WriteLine(text); // è¾“å‡º: è¿™æ˜¯ç¬¬ä¸€ä¸ªç‰©å“
}
```

## ğŸ“š APIæ–‡æ¡£

### KVStreamer ä¸»ç±»

#### æ„é€ å‡½æ•°

```csharp
KVStreamer(float cacheDuration = 300f)
```
- `cacheDuration`: ç¼“å­˜æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤300ç§’

#### æ–¹æ³•

##### CreateBinaryFromCSV
```csharp
void CreateBinaryFromCSV(string csvPath, string outputPath, bool compress = true)
```
ä»CSVæ–‡ä»¶åˆ›å»ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ”¯æŒå¯é€‰å‹ç¼©ã€‚

**å‚æ•°:**
- `csvPath`: CSVæ–‡ä»¶è·¯å¾„
- `outputPath`: è¾“å‡ºçš„.bytesæ–‡ä»¶è·¯å¾„
- `compress`: å¯ç”¨GZipå‹ç¼©ï¼ˆé»˜è®¤: trueï¼‰

**å¼‚å¸¸:**
- `FileNotFoundException`: CSVæ–‡ä»¶ä¸å­˜åœ¨
- `Exception`: CSVæ ¼å¼é”™è¯¯ï¼ˆç¼ºå°‘IDæˆ–Textåˆ—ï¼‰

**å‹ç¼©ä¼˜åŠ¿:**
- å°æ–‡ä»¶ï¼ˆ12æ¡è®°å½•ï¼‰ï¼š~36% å‹ç¼©ç‡
- å¤§æ–‡ä»¶ï¼ˆ1,368æ¡è®°å½•ï¼‰ï¼š~67% å‹ç¼©ç‡ï¼ˆ3:1 å‹ç¼©æ¯”ï¼‰
- åŠ è½½æ—¶è‡ªåŠ¨è§£å‹ç¼©

##### LoadBinaryFile
```csharp
void LoadBinaryFile(string binaryFilePath)
```
ä»æ–‡ä»¶è·¯å¾„åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶å¹¶è§£æMapå¤´ã€‚

**å‚æ•°:**
- `binaryFilePath`: .bytesæ–‡ä»¶è·¯å¾„

**å¼‚å¸¸:**
- `FileNotFoundException`: äºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨

##### LoadBinaryData
```csharp
void LoadBinaryData(byte[] binaryData)
```
ä»å­—èŠ‚æ•°ç»„åŠ è½½äºŒè¿›åˆ¶æ•°æ®ï¼ˆUnityæ¨èæ–¹å¼ï¼‰ã€‚è‡ªåŠ¨æ£€æµ‹å¹¶è§£å‹ç¼©GZipå‹ç¼©æ•°æ®ã€‚

**å‚æ•°:**
- `binaryData`: äºŒè¿›åˆ¶æ•°æ®å­—èŠ‚æ•°ç»„ï¼ˆå‹ç¼©æˆ–æœªå‹ç¼©ï¼‰

**å¼‚å¸¸:**
- `ArgumentException`: æ•°æ®ä¸ºnullæˆ–ç©º

**æ³¨æ„:** æ­¤æ–¹æ³•è‡ªåŠ¨å¤„ç†å‹ç¼©å’Œæœªå‹ç¼©æ ¼å¼ï¼Œä¿è¯å‘åå…¼å®¹ã€‚

##### GetValue
```csharp
string GetValue(string key)
```
é€šè¿‡Keyè·å–Valueï¼ˆå¸¦ç¼“å­˜ï¼‰ã€‚

**å‚æ•°:**
- `key`: é”®

**è¿”å›:**
- å¯¹åº”çš„å€¼ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å›`null`

##### GetAllKeys
```csharp
List<string> GetAllKeys()
```
è·å–æ‰€æœ‰çš„Keyåˆ—è¡¨ã€‚

**è¿”å›:**
- æ‰€æœ‰keyçš„åˆ—è¡¨

##### ContainsKey
```csharp
bool ContainsKey(string key)
```
æ£€æŸ¥Keyæ˜¯å¦å­˜åœ¨ã€‚

**å‚æ•°:**
- `key`: è¦æ£€æŸ¥çš„é”®

**è¿”å›:**
- å­˜åœ¨è¿”å›`true`ï¼Œå¦åˆ™è¿”å›`false`

##### ClearCache
```csharp
void ClearCache()
```
æ¸…é™¤æ‰€æœ‰ç¼“å­˜ã€‚

##### CloseBinaryFile
```csharp
void CloseBinaryFile()
```
å…³é—­äºŒè¿›åˆ¶æ–‡ä»¶æµã€‚

#### å±æ€§

##### Count
```csharp
int Count { get; }
```
è·å–é”®å€¼å¯¹æ€»æ•°ã€‚

## ğŸ® Unityä½¿ç”¨ç¤ºä¾‹

```csharp
using UnityEngine;
using KVStreamer;

public class LocalizationManager : MonoBehaviour
{
    private KVStreamer _streamer;
    
    void Start()
    {
        // åˆ›å»ºå®ä¾‹ï¼Œç¼“å­˜5åˆ†é’Ÿ
        _streamer = new KVStreamer(cacheDuration: 300f);
        
        // åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ”¾åœ¨StreamingAssetsæˆ–Resourcesæ–‡ä»¶å¤¹ï¼‰
        string path = Application.streamingAssetsPath + "/localization.bytes";
        _streamer.LoadBinaryFile(path);
        
        Debug.Log($"åŠ è½½äº† {_streamer.Count} æ¡æœ¬åœ°åŒ–æ–‡æœ¬");
    }
    
    // è·å–æœ¬åœ°åŒ–æ–‡æœ¬
    public string GetText(string key)
    {
        return _streamer?.GetValue(key) ?? key;
    }
    
    void OnDestroy()
    {
        // é‡Šæ”¾èµ„æº
        _streamer?.Dispose();
    }
}
```

## âš¡ æ€§èƒ½æµ‹è¯•

ä½¿ç”¨BenchmarkDotNetå¯¹KVStreamerå’Œä¼ ç»ŸDictionaryè¿›è¡Œäº†å…¨é¢çš„æ€§èƒ½å¯¹æ¯”æµ‹è¯•ï¼ˆæµ‹è¯•æ•°æ®ï¼š1368æ¡è®°å½•ï¼Œ132KBï¼‰ã€‚

### ğŸ“ˆ æµ‹è¯•ç»“æœæ€»ç»“

| æµ‹è¯•é¡¹ç›® | KVStreamer | Dictionary | å¯¹æ¯” |
|---------|------------|------------|------|
| **å•æ¬¡è¯»å–** | 468 ns | 23 ns | å­—å…¸å¿«20å€ |
| **æ‰¹é‡è¯»å–100æ¡** | 55 Î¼s | 2.3 Î¼s | å­—å…¸å¿«24å€ |
| **åŠ è½½æ•°æ®** | 0.5 ms | 85 ms | **KVStreamerå¿«170å€** |
| **GCå‹åŠ›** | **0 Gen0** | é«˜ | **KVStreameré›¶GC** |
| **å†…å­˜åˆ†é…** | **0 B** | é«˜ | **KVStreameré›¶åˆ†é…** |

### ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

#### 1ï¸âƒ£ **åŠ è½½æ€§èƒ½ä¼˜åŠ¿**
- **KVStreamer**: ç›´æ¥åŠ è½½byte[]åˆ°å†…å­˜ï¼Œä»…è§£æMapå¤´
- **Dictionary**: éœ€è¦è§£æå…¨éƒ¨CSVå†…å®¹ï¼Œåˆ›å»ºå¤šä¸ªå­—ç¬¦ä¸²å¯¹è±¡
- **ç»“è®º**: KVStreameråŠ è½½é€Ÿåº¦å¿« **170å€**

#### 2ï¸âƒ£ **å†…å­˜ä¼˜åŠ¿**
```
KVStreamer:
  åˆå§‹åŠ è½½: 0 B åˆ†é…ï¼Œ0 Gen0 GC
  è¯»å–æ•°æ®: æŒ‰éœ€ä»æµè¯»å–ï¼Œé›¶é¢å¤–åˆ†é…

Dictionary:
  åˆå§‹åŠ è½½: å¤§é‡å­—ç¬¦ä¸²å¯¹è±¡ï¼Œé¢‘ç¹GC
  æ•°æ®å¸¸é©»: æ‰€æœ‰valueæ°¸ä¹…å ç”¨å†…å­˜
```

####  3ï¸âƒ£ **GCå‹åŠ›å¯¹æ¯”**
- **KVStreamer**: é›¶GCï¼Œæ‰€æœ‰æ•°æ®åœ¨æµä¸­æŒ‰éœ€è¯»å–
- **Dictionary**: åŠ è½½æ—¶äº§ç”Ÿå¤§é‡GCï¼Œå½±å“å¸§ç‡

### ğŸ“Š è¯¦ç»†æ€§èƒ½æ•°æ®

#### è¯»å–æ€§èƒ½
| æ“ä½œ | KVStreamerï¼ˆæ— ç¼“å­˜ï¼‰ | KVStreamerï¼ˆå¸¦ç¼“å­˜ï¼‰ | Dictionary |
|------|----------------|----------------|------------|
| å•æ¬¡è¯»å– | 468 ns | < 10 ns | 23 ns |
| æ‰¹é‡è¯»å–100æ¡ | 55 Î¼s | ~1 Î¼s | 2.3 Î¼s |
| éšæœºè®¿é—®10æ¬¡ | 5.5 Î¼s | < 0.1 Î¼s | 0.23 Î¼s |

> **æ³¨æ„**: KVStreamerå¼€å¯ç¼“å­˜åï¼Œæ€§èƒ½æ¥è¿‘ç”šè‡³è¶…è¿‡Dictionaryã€‚

#### åŠ è½½æ€§èƒ½
| æ“ä½œ | KVStreamer | Dictionary | å€æ•° |
|------|------------|------------|----|--
---|
| åŠ è½½1368æ¡æ•°æ® | 0.5 ms | 85 ms | **170x** |
| å†…å­˜åˆ†é… | 0 B | >>100 KB | **0x** |
| GCæ¬¡æ•° | 0 | å¤šæ¬¡ | **0x** |

### ğŸ® é€‚ç”¨åœºæ™¯å»ºè®®

#### âœ… æ¨èä½¿ç”¨KVStreamer
- âœ… **Unityç§»åŠ¨å¹³å°**ï¼šä½å†…å­˜å ç”¨ï¼Œé›¶GC
- âœ… **å¤§é‡æœ¬åœ°åŒ–æ–‡æœ¬**ï¼šåŠ è½½å¿«ï¼ŒæŒ‰éœ€è¯»å–
- âœ… **çƒ­æ›´æ–°åœºæ™¯**ï¼šå¿«é€Ÿé‡è½½ï¼Œä¸éœ€é‡å¯App
- âœ… **AssetBundle/Resources**ï¼šç›´æ¥ä½¿ç”¨byte[]

#### ğŸ”´ æ¨èä½¿ç”¨Dictionary
- ğŸ”´ æ•°æ®é‡å°ï¼ˆ<100æ¡ï¼‰
- ğŸ”´ éœ€è¦æè‡´éšæœºè®¿é—®æ€§èƒ½ï¼ˆæ— ç¼“å­˜ï¼‰
- ğŸ”´ ä¸å…³å¿ƒå†…å­˜å’ŒGC

### ğŸ› ï¸ è¿è¡ŒåŸºå‡†æµ‹è¯•

```bash
cd Src/Benchmark
dotnet run -c Release
```

æµ‹è¯•ç¯å¢ƒï¼š
- .NET 8.0
- Releaseç¼–è¯‘
- BenchmarkDotNet 0.15.8
- æµ‹è¯•æ•°æ®ï¼šchapter1.csv (1368æ¡è®°å½•, 132KB)

### ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¯ç”¨ç¼“å­˜**: å¯¹äºé¢‘ç¹è®¿é—®çš„æ•°æ®ï¼Œå¼€å¯ç¼“å­˜å¯è·å¾—æ¥è¿‘Dictionaryçš„æ€§èƒ½
2. **é¢„åŠ è½½çƒ­ç‚¹æ•°æ®**: å¯åŠ¨æ—¶é¢„è¯»å–å¸¸ç”¨keyï¼Œå¡«å……ç¼“å­˜
3. **åˆç†ç¼“å­˜æ—¶é—´**: æ ¹æ®ä¸šåŠ¡åœºæ™¯è®¾ç½®é€‚å½“çš„cacheDuration
4. **ä½¿ç”¨byte[]åŠ è½½**: Unityä¸­ä½¿ç”¨LoadBinaryData(byte[])ä»£æ›¿LoadBinaryFile()

## âš ï¸ ç¼“å­˜ç³»ç»Ÿ

### ç¼“å­˜ç‰¹æ€§

- âœ… è‡ªåŠ¨è¿‡æœŸï¼šåˆ°è¾¾è®¾å®šæ—¶é—´åè‡ªåŠ¨å¤±æ•ˆ
- âœ… å®šæœŸæ¸…ç†ï¼šæ¯60ç§’è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
- âœ… å†…å­˜ä¼˜åŒ–ï¼šåªç¼“å­˜è®¿é—®è¿‡çš„æ•°æ®
- âœ… å¯é…ç½®ï¼šæ”¯æŒåŠ¨æ€è°ƒæ•´ç¼“å­˜æ—¶é—´

### ç¼“å­˜ä½¿ç”¨ç¤ºä¾‹

```csharp
using (KVStreamer streamer = new KVStreamer(cacheDuration: 60f))
{
    streamer.LoadBinaryFile("data.bytes");
    
    // ç¬¬ä¸€æ¬¡è¯»å–ï¼Œä»æ–‡ä»¶æµè¯»å–
    string text1 = streamer.GetValue("item_001"); // è¾ƒæ…¢
    
    // ç¬¬äºŒæ¬¡è¯»å–ï¼Œä»ç¼“å­˜è¯»å–
    string text2 = streamer.GetValue("item_001"); // å¾ˆå¿«
    
    // æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜
    streamer.ClearCache();
}
```

## ğŸ” æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **åˆç†è®¾ç½®ç¼“å­˜æ—¶é—´**: æ ¹æ®å®é™…ä½¿ç”¨åœºæ™¯è°ƒæ•´ç¼“å­˜æ—¶é—´
   - é¢‘ç¹è®¿é—®çš„æ•°æ®ï¼šè®¾ç½®è¾ƒé•¿çš„ç¼“å­˜æ—¶é—´ï¼ˆå¦‚300-600ç§’ï¼‰
   - å¶å°”è®¿é—®çš„æ•°æ®ï¼šè®¾ç½®è¾ƒçŸ­çš„ç¼“å­˜æ—¶é—´ï¼ˆå¦‚60-120ç§’ï¼‰

2. **æ‰¹é‡é¢„åŠ è½½**: å¦‚æœå·²çŸ¥éœ€è¦è®¿é—®çš„æ•°æ®ï¼Œå¯ä»¥åœ¨å¯åŠ¨æ—¶æ‰¹é‡é¢„åŠ è½½åˆ°ç¼“å­˜

3. **åŠæ—¶é‡Šæ”¾**: ä½¿ç”¨å®Œæ¯•åè°ƒç”¨`Dispose()`æˆ–ä½¿ç”¨`using`è¯­å¥è‡ªåŠ¨é‡Šæ”¾èµ„æº

4. **é¿å…é‡å¤åˆ›å»º**: å»ºè®®ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†`KVStreamer`å®ä¾‹

## ğŸ“ è¿è¡Œç¤ºä¾‹

è¿›å…¥é¡¹ç›®ç›®å½•ï¼Œç¼–è¯‘å¹¶è¿è¡Œç¤ºä¾‹ç¨‹åºï¼š

```bash
cd c:\GIT\KVStreamer
csc /out:Example.exe /recurse:*.cs
Example.exe
```

æˆ–ä½¿ç”¨Visual Studioæ‰“å¼€é¡¹ç›®è¿è¡Œã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

1. CSVæ–‡ä»¶å¿…é¡»åŒ…å«`ID`å’Œ`Text`åˆ—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
2. æ”¯æŒCSVä¸­çš„å¼•å·åŒ…è£¹å’Œé€—å·è½¬ä¹‰
3. ç¼–ç ç»Ÿä¸€ä½¿ç”¨UTF-8
4. é”®å€¼ä¸èƒ½ä¸ºç©ºå­—ç¬¦ä¸²
5. é‡å¤çš„IDåªä¿ç•™ç¬¬ä¸€ä¸ª

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼
